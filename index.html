<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Balancer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        input[type="number"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .player-section {
            margin-bottom: 30px;
        }

        .player-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .player-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .player-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .player-item label {
            flex: 1;
            cursor: pointer;
            margin: 0;
            font-weight: normal;
        }

        .power-input {
            width: 60px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
            font-size: 0.9em;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 30px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        #result {
            margin-top: 30px;
        }

        .teams-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .team {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .team:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .team h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .team-stats {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.6);
            border-radius: 5px;
        }

        .team ul {
            list-style-type: none;
            padding: 0;
        }

        .team li {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .player-name {
            font-weight: 600;
            color: #333;
        }

        .player-level {
            color: #666;
            font-size: 0.9em;
        }

        .metrics {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .metrics h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .metrics p {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #764ba2;
        }

        .metric-label {
            font-weight: 600;
            color: #555;
        }

        .empty-message {
            padding: 20px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            color: #856404;
            text-align: center;
        }

        .error-message {
            padding: 20px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            color: #721c24;
            text-align: center;
        }

        .player-count {
            margin-bottom: 15px;
            padding: 10px;
            background: #e7f3ff;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .player-count.correct {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .player-count.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .add-player-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border: 2px dashed #ddd;
            align-items: center;
        }

        .add-player-form input[type="text"] {
            flex: 1;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
        }

        .add-player-form input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-player-form input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
        }

        .btn-small {
            padding: 8px 20px;
            font-size: 0.9em;
            margin: 0;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            padding: 5px 12px;
            font-size: 0.85em;
        }

        .btn-danger:hover {
            box-shadow: 0 5px 20px rgba(220, 53, 69, 0.4);
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background 0.2s;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .copy-teams-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            margin-top: 20px;
            display: inline-block;
        }

        .copy-success {
            display: inline-block;
            margin-left: 15px;
            color: #28a745;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .copy-success.show {
            opacity: 1;
        }

        .copy-container {
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .teams-container {
                grid-template-columns: 1fr;
            }

            .controls {
                grid-template-columns: 1fr;
            }

            .add-player-form {
                flex-direction: column;
            }

            .add-player-form input,
            .add-player-form button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öñÔ∏è Team Balancer</h1>
        <p class="subtitle">Balance selected players into 3 balanced teams</p>

        <div class="controls">
            <div class="control-group">
                <label for="players-per-team">Players per Team:</label>
                <input type="number" id="players-per-team" name="players-per-team" min="1" value="4">
            </div>
        </div>

        <div class="player-section">
            <h2>Players & Powers</h2>
            <div class="player-count" id="player-count">
                Selected: 0 / Required: 12
            </div>
            <div class="add-player-form">
                <input type="text" id="new-player-name" placeholder="Player name" maxlength="50">
                <input type="number" id="new-player-power" placeholder="Power" min="0" step="0.1" value="3">
                <button type="button" class="btn-small" onclick="addPlayer()">Add Player</button>
            </div>
            <div class="player-list" id="player-list">
                <!-- Player checkboxes and power inputs will be inserted here -->
            </div>
        </div>

        <button type="button" onclick="generateTeams()">Generate Teams</button>

        <div id="result"></div>
    </div>

    <script>
        // Store generated teams for copying
        let generatedTeams = null;

        // Default player list with powers
        let players = {
            "–î–∞—É—Ä–µ–Ω": 3,
            "–ì–∞–ª–∏": 6,
            "–°–∞–¥–¥–∞–º": 6,
            "–†–∞—Å—É–ª": 6,
            "–ñ–∞–Ω–≥–∏—Ä": 3,
            "–ê—Å–∫–∞—Ä": 3,
            "–ê–¥–∏–ª—å": 1,
            "–ì–∞–±–∏—Ç": 6,
            "–ê–ª–∏–±–µ–∫": 4,
            "–ê—è–Ω": 4,
            "–†—É—Å—Ç–∞–º": 6,
            "–¢–∞–º–µ—Ä": 2,
            "–î–∏–º–∞": 5,
            "–ê–∫–Ω–∞–∑–∞—Ä": 6,
            "–Æ—Ä–∞": 3,
            "–†–∞—Ö–∞—Ç": 1,
            "–ê–∑–∞—Ç": 3,
            "–û–ª–∂–∞—Å": 3,
            "–†–∞—Ö–º–∞–Ω": 6,
            "–¢–∏–º—É—Ä": 4,
            "–î–∞–Ω–∏—è—Ä": 4.5,
            "–ê–π—Ç": 4.5,
            "–ú–∞–¥–∏": 6,
            "–ê—Å–∞–¥": 1
        };

        // Shuffle array function
        function shuffle(array) {
            const arr = array.slice();
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // Calculate standard deviation
        function std(values) {
            if (values.length === 0) return 0;
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            return Math.sqrt(values.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / values.length);
        }

        // Calculate team statistics
        function teamStats(teams) {
            const sums = teams.map(team => team.reduce((s, p) => s + p.level, 0));
            const sixCounts = teams.map(team => team.filter(p => p.level === 6).length);
            const fiveCounts = teams.map(team => team.filter(p => p.level === 5).length);
            return { sums, sixCounts, fiveCounts };
        }

        // Generate teams (always 3 teams)
        function generateTeams() {
            const container = document.getElementById('result');
            container.innerHTML = '';
            generatedTeams = null; // Reset stored teams

            // Get selected players and their current powers
            const selected = [];
            const checkboxes = document.querySelectorAll('#player-list input[type=checkbox]');
            
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    const name = cb.value;
                    const powerInput = document.getElementById(`power-${name}`);
                    const power = parseFloat(powerInput.value) || 1;
                    selected.push({ name: name, level: power });
                    // Update players object with new power
                    players[name] = power;
                }
            });

            if (selected.length === 0) {
                container.innerHTML = '<div class="empty-message">Please select at least one player.</div>';
                return;
            }

            const playersPerTeam = parseInt(document.getElementById('players-per-team').value) || 4;
            const totalPlayers = selected.length;
            const targetTeams = 3;
            const requiredPlayers = playersPerTeam * targetTeams;

            // Validate that we can create 3 teams
            if (totalPlayers < targetTeams) {
                container.innerHTML = `<div class="error-message">Need at least ${targetTeams} players to create ${targetTeams} teams.</div>`;
                return;
            }

            // Validate exact player count requirement
            if (totalPlayers !== requiredPlayers) {
                container.innerHTML = `<div class="error-message">You need exactly <strong>${requiredPlayers}</strong> players selected (${playersPerTeam} per team √ó 3 teams). Currently selected: <strong>${totalPlayers}</strong>.</div>`;
                return;
            }

            // Initialize 3 teams
            const teams = [[], [], []];
            const teamSums = [0, 0, 0];

            // Shuffle selected players
            const shuffled = shuffle(selected.slice());

            // Group players by level
            const byLevel = {};
            shuffled.forEach(p => {
                const lvl = p.level;
                if (!byLevel[lvl]) byLevel[lvl] = [];
                byLevel[lvl].push(p);
            });

            let start = 0;

            // Round-robin distribution function
            function roundRobinDistribute(pool) {
                let idx = start;
                for (let i = 0; i < pool.length; i++) {
                    let p = pool[i];
                    let tries = 0;
                    while (teams[idx].length >= playersPerTeam && tries < targetTeams) {
                        idx = (idx + 1) % targetTeams;
                        tries++;
                    }
                    if (teams[idx].length < playersPerTeam) {
                        teams[idx].push(p);
                        teamSums[idx] += p.level;
                    }
                    idx = (idx + 1) % targetTeams;
                }
            }

            // Distribute level 6 players first
            const sixPool = byLevel[6] || [];
            if (sixPool.length > 0) {
                roundRobinDistribute(sixPool);
                start = (start + 1) % targetTeams;
            }

            // Distribute level 5 players
            const fivePool = byLevel[5] || [];
            if (fivePool.length > 0) {
                roundRobinDistribute(fivePool);
                start = (start + 1) % targetTeams;
            }

            // Distribute remaining players (by level, descending)
            const restLevels = Object.keys(byLevel)
                .filter(lvl => lvl !== '5' && lvl !== '6')
                .map(lvl => parseFloat(lvl))
                .sort((a, b) => b - a);

            const rest = [];
            restLevels.forEach(lvl => {
                if (byLevel[lvl]) {
                    byLevel[lvl].forEach(p => rest.push(p));
                }
            });

            // Greedy assignment for remaining players
            rest.forEach(p => {
                let bestIdx = null;
                let bestSum = Infinity;
                let bestLen = Infinity;

                for (let i = 0; i < targetTeams; i++) {
                    if (teams[i].length < playersPerTeam) {
                        if (teamSums[i] < bestSum || 
                            (teamSums[i] === bestSum && teams[i].length < bestLen)) {
                            bestIdx = i;
                            bestSum = teamSums[i];
                            bestLen = teams[i].length;
                        }
                    }
                }

                // If all teams are full, find the one with lowest sum
                if (bestIdx === null) {
                    bestSum = Math.min(...teamSums);
                    bestIdx = teamSums.indexOf(bestSum);
                }

                teams[bestIdx].push(p);
                teamSums[bestIdx] += p.level;
            });

            // Display results
            const stats = teamStats(teams);
            let html = '<div class="teams-container">';

            teams.forEach((team, idx) => {
                html += `<div class="team">
                    <h2>Team ${idx + 1}</h2>
                    <div class="team-stats">
                        <div><strong>Total Power:</strong> ${stats.sums[idx].toFixed(1)}</div>
                        <div><strong>Level 6:</strong> ${stats.sixCounts[idx]} | <strong>Level 5:</strong> ${stats.fiveCounts[idx]}</div>
                        <div><strong>Players:</strong> ${team.length}</div>
                    </div>
                    <ul>`;
                team.forEach(p => {
                    html += `<li>
                        <span class="player-name">${p.name}</span>
                        <span class="player-level">(power: ${p.level})</span>
                    </li>`;
                });
                html += '</ul></div>';
            });

            html += '</div>';

            // Add metrics
            html += '<div class="metrics">';
            html += '<h3>Balance Metrics</h3>';
            html += `<p>
                <span class="metric-label">Power Sums:</span> 
                [${stats.sums.map(v => v.toFixed(1)).join(', ')}] 
                <strong>(œÉ = ${std(stats.sums).toFixed(3)})</strong>
            </p>`;
            html += `<p>
                <span class="metric-label">Level 6 Players:</span> 
                [${stats.sixCounts.join(', ')}] 
                <strong>(œÉ = ${std(stats.sixCounts).toFixed(3)})</strong>
            </p>`;
            html += `<p>
                <span class="metric-label">Level 5 Players:</span> 
                [${stats.fiveCounts.join(', ')}] 
                <strong>(œÉ = ${std(stats.fiveCounts).toFixed(3)})</strong>
            </p>`;
            html += '</div>';

            // Add copy button
            html += '<div class="copy-container">';
            html += '<button type="button" class="copy-teams-btn" onclick="copyTeamsToClipboard()">üìã Copy Teams</button>';
            html += '<span class="copy-success" id="copy-success">‚úì Copied to clipboard!</span>';
            html += '</div>';

            container.innerHTML = html;
            
            // Store teams for copying
            generatedTeams = teams;
        }

        // Copy teams to clipboard in WhatsApp format
        function copyTeamsToClipboard() {
            if (!generatedTeams) {
                alert('No teams generated yet. Please generate teams first.');
                return;
            }

            let text = '';
            
            generatedTeams.forEach((team, idx) => {
                text += `Team ${idx + 1}:\n`;
                team.forEach(p => {
                    text += `${p.name}\n`;
                });
                text += '\n';
            });

            // Remove trailing newlines
            text = text.trim();

            // Copy to clipboard
            navigator.clipboard.writeText(text).then(() => {
                // Show success message
                const successMsg = document.getElementById('copy-success');
                if (successMsg) {
                    successMsg.classList.add('show');
                    setTimeout(() => {
                        successMsg.classList.remove('show');
                    }, 2000);
                }
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const successMsg = document.getElementById('copy-success');
                    if (successMsg) {
                        successMsg.classList.add('show');
                        setTimeout(() => {
                            successMsg.classList.remove('show');
                        }, 2000);
                    }
                } catch (err) {
                    alert('Failed to copy. Please manually copy the teams.');
                }
                document.body.removeChild(textArea);
            });
        }

        // Update player count display
        function updatePlayerCount() {
            const countElement = document.getElementById('player-count');
            const checkboxes = document.querySelectorAll('#player-list input[type=checkbox]');
            const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const playersPerTeam = parseInt(document.getElementById('players-per-team').value) || 4;
            const requiredCount = playersPerTeam * 3;

            countElement.textContent = `Selected: ${selectedCount} / Required: ${requiredCount}`;
            
            // Update styling based on count
            countElement.className = 'player-count';
            if (selectedCount === requiredCount) {
                countElement.className += ' correct';
            } else if (selectedCount > requiredCount || selectedCount < requiredCount) {
                countElement.className += ' warning';
            }
        }

        // Create player list with checkboxes and power inputs
        function createPlayerList() {
            const container = document.getElementById('player-list');
            container.innerHTML = ''; // Clear existing
            const names = Object.keys(players);
            
            // Sort alphabetically
            names.sort((a, b) => a.localeCompare(b, 'en', { sensitivity: 'base' }));

            names.forEach(name => {
                const level = players[name];
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-item';
                playerDiv.id = `player-item-${name}`;

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `player-${name}`;
                checkbox.value = name;
                checkbox.checked = true;
                checkbox.addEventListener('change', updatePlayerCount);

                const label = document.createElement('label');
                label.setAttribute('for', `player-${name}`);
                label.textContent = name;

                const powerInput = document.createElement('input');
                powerInput.type = 'number';
                powerInput.id = `power-${name}`;
                powerInput.className = 'power-input';
                powerInput.value = level;
                powerInput.min = 0;
                powerInput.step = 0.1;
                powerInput.addEventListener('change', function() {
                    const newPower = parseFloat(this.value);
                    if (!isNaN(newPower) && newPower >= 0) {
                        players[name] = newPower;
                    }
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '√ó';
                deleteBtn.title = 'Remove player';
                deleteBtn.onclick = () => removePlayer(name);

                playerDiv.appendChild(checkbox);
                playerDiv.appendChild(label);
                playerDiv.appendChild(powerInput);
                playerDiv.appendChild(deleteBtn);

                container.appendChild(playerDiv);
            });
            
            updatePlayerCount();
        }

        // Add new player
        function addPlayer() {
            const nameInput = document.getElementById('new-player-name');
            const powerInput = document.getElementById('new-player-power');
            const name = nameInput.value.trim();
            const power = parseFloat(powerInput.value);

            if (!name) {
                alert('Please enter a player name');
                return;
            }

            if (players[name]) {
                alert('Player with this name already exists');
                return;
            }

            if (isNaN(power) || power < 0) {
                alert('Please enter a valid power value (‚â• 0)');
                return;
            }

            // Add player to the players object
            players[name] = power;

            // Recreate the player list
            createPlayerList();

            // Clear input fields
            nameInput.value = '';
            powerInput.value = '3';

            // Focus on name input for next entry
            nameInput.focus();
        }

        // Remove player
        function removePlayer(name) {
            if (confirm(`Remove player "${name}"?`)) {
                delete players[name];
                createPlayerList();
            }
        }

        // Set up event listeners after DOM is ready
        function setupEventListeners() {
            const playersPerTeamInput = document.getElementById('players-per-team');
            if (playersPerTeamInput) {
                playersPerTeamInput.addEventListener('input', updatePlayerCount);
                playersPerTeamInput.addEventListener('change', updatePlayerCount);
            }

            // Allow Enter key to add player
            const newPlayerNameInput = document.getElementById('new-player-name');
            const newPlayerPowerInput = document.getElementById('new-player-power');
            
            if (newPlayerNameInput) {
                newPlayerNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addPlayer();
                    }
                });
            }
            
            if (newPlayerPowerInput) {
                newPlayerPowerInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addPlayer();
                    }
                });
            }
        }

        // Initialize on page load
        createPlayerList();
        setupEventListeners();
    </script>
</body>
</html>
